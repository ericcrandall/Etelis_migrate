[
  {
    "objectID": "Etelis_migrate.html",
    "href": "Etelis_migrate.html",
    "title": "Gene Flow Models for Etelis spp. Deepwater Snappers",
    "section": "",
    "text": "Here I’m just loading a bunch of R packages that we’ll need.\n\n\nCode\nlibrary(tidyverse)\nlibrary(ape)\nlibrary(phangorn)\nlibrary(pegas)\n#library(strataG)\n#library(emo)\nlibrary(coda)\nlibrary(ggmcmc)\nlibrary(perm)\nlibrary(snpR)\nlibrary(adegenet)\n\n\n\n\n\nAnd here are some homebrewed functions that will be helpful.\n\n\nCode\n# Function library\nharvest.model.likelihoods <- function(workingDir = workingDir,\n                                      outfileName = \"outfile.txt\",\n                                      multilocus = T){\n    # this function harvests model marginal likelihoods for models calculated by\n    # the program migrate-n (Beerli & Felsenstein 2001).\n    # It takes as input a directory full of directories, \n    # each of which contains output from a migrate model, and is named\n    # after that model. \n  \n    #initialize a data frame to take the values\n    modelMarglikes <- data.frame(model=character(),\n                             thermodynamic=numeric(),\n                             bezier.corrected=numeric(), \n                             harmonic=numeric()) \n    # loop through directories in the working directory, each of which is name\n    # after a different model\n  for(i in list.dirs(workingDir, full.names = F)[-1]){ #i<-\"stepping.stone\"\n      modelDir<-file.path(workingDir,i)\n      print(modelDir)\n    #scan in the outfile, separating at each newline\n      outfile<-scan(file=file.path(modelDir,outfileName),what=\"character\",sep=\"\\n\") \n    #find the line with the likelihoods on it and split on runs of spaces\n      marglikeline <- strsplit(grep(\"  All          \",outfile,value=T),\n                               \"\\\\s+\", perl = T)[[1]][3:5]\n    #  if(length(marglikeline)==0){next}\n      marglikes <- c(i,marglikeline)\n     \n      modelMarglikes <- rbind(modelMarglikes,marglikes, deparse.level = 2)\n  }\n  names(modelMarglikes) <- c(\"model\",\"thermodynamic\",\"bezier.corrected\",\"harmonic\")\n  modelMarglikes[2:4] <- sapply(modelMarglikes[2:4], as.numeric)\n  return(modelMarglikes)\n}\n\nbfcalcs<-function(df,ml=\"bezier.corrected\"){\n  # This calculates log bayes factors on data frames output by\n  # harvest.model.likelihoods(), following Johnson and Omland (2004)\n  # You may choose the likelihood flavor with\n  # ml = \"bezier.corrected\", \"thermodynamic\" or \"harmonic\"\n  #df$thermodynamic <- as.numeric(df$thermodynamic)\n  #df$bezier.corrected <- as.numeric(df$bezier.corrected)\n  #df$harmonic <- as.numeric(df$harmonic)\n  mlcol <- df[[ml]] \n    bmvalue <- mlcol[which.max(mlcol)]\n    lbf <- 2*(mlcol-bmvalue)\n    choice <- rank(-mlcol)\n    modelprob <- exp(lbf/2)/sum(exp(lbf/2))\n    dfall <- cbind(df,lbf,choice,modelprob)\n    return(dfall)\n}   \n\nmigrants.per.gen<-function(x){\n  #a function for creating Nm vectors out of m and Theta vectors.\n  #x<-x[[1]]\n  m<-names(x)[which(grepl(\"M_\",names(x)))] #names of m columns\n  #theta<-names(x)[which(grepl(\"Theta_\",names(x)))] #names of theta columns\n  for(n in m){\n    t<-paste(\"Theta\",strsplit(n,split=\"_\")[[1]][3],sep=\"_\")\n    x[,paste(\"Nm\",strsplit(n,split=\"_\")[[1]][2],strsplit(n,split=\"_\")[[1]][3],sep=\"_\")]<- x[,which(names(x)==n)]*x[,which(names(x)==t)] \n    #this hairy little statement makes a new column named \"Nm_X_Y\" and then fills it by multiplying the M_X_Y column by the Theta_Y column  \n  }\n  return(x)\n}"
  },
  {
    "objectID": "Etelis_migrate.html#clean-the-data-with-process_radtags",
    "href": "Etelis_migrate.html#clean-the-data-with-process_radtags",
    "title": "Gene Flow Models for Etelis spp. Deepwater Snappers",
    "section": "Clean the data with process_radtags",
    "text": "Clean the data with process_radtags\nSame commands for carbunculus and coruscans. Paired end. Look for ecoR1 cutsites on read 1 and mspI cutsites on read 2. Remove low quality reads (based on a sliding window average). Remove reads smaller than 145 bp, and trim others to that length.\n\nprocess_radtags -p ./raw/ -o ./cleaned/ --rescue --clean --quality --paired --threads 12 --renz-1 ecoRI --renz-2 mspI  \\\n                  --truncate 145 --len-limit 145 \\\n                  --adapter-1 GATCGGAAGAGCGGTTCAGCAGGAATGCCGAGACCGATCTCGTATGCCGTCTTCTGCTTG \\\n                  --adapter-2 AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGTAGATCTCGGTGGTCGCCGTATCATT \\\n                  --adapter-mm 2\n\n\nE. carbunculus output\nBEGIN total_raw_read_counts  \nTotal Sequences 255732606  \nReads containing adapter sequence       1957206 0.8%  \nBarcode Not Found       0       0.0%  \nLow Quality     6558845 2.6%  \nRAD Cutsite Not Found   1678118 0.7%  \nRetained Reads  245538437       96.0%  \nEND total_raw_read_counts  \n\n\nE. coruscans output\nBEGIN total_raw_read_counts  \nTotal Sequences 272955592  \nReads containing adapter sequence       1919907 0.7%  \nBarcode Not Found       0       0.0%  \nLow Quality     8734891 3.2%  \nRAD Cutsite Not Found   1884115 0.7%  \nRetained Reads  260416679       95.4%  \nEND total_raw_read_counts"
  },
  {
    "objectID": "Etelis_migrate.html#running-the-denovo_map.pl-pipeline",
    "href": "Etelis_migrate.html#running-the-denovo_map.pl-pipeline",
    "title": "Gene Flow Models for Etelis spp. Deepwater Snappers",
    "section": "Running the denovo_map.pl pipeline",
    "text": "Running the denovo_map.pl pipeline\nHmm… gotta rename the cleaned files too. All code is being run on both species.\n\nMore renaming\n\ncd cleaned\nfor f in *001.1.fq.gz\ndo\nmv $f ${f/_R[12]_001.1.fq.gz/.1.fq.gz}\ndone\n\nfor f in *001.2.fq.gz\ndo\nmv $f ${f/_R[12]_001.2.fq.gz/.2.fq.gz}\ndone\n\n#rename the \"remainder reads\" that have had their pair removed for low quality\nfor f in *001.rem.1.fq.gz; do mv $f ${f/_R[12]_001.rem.1.fq.gz/.rem.1.fq.gz}; done\nfor f in *001.rem.2.fq.gz; do mv $f ${f/_R[12]_001.rem.2.fq.gz/.rem.2.fq.gz}; done"
  },
  {
    "objectID": "Etelis_migrate.html#removing-extra-flags",
    "href": "Etelis_migrate.html#removing-extra-flags",
    "title": "Gene Flow Models for Etelis spp. Deepwater Snappers",
    "section": "Removing extra flags",
    "text": "Removing extra flags\nOy - so denovo_map.pl crashed with this message:\n\nError: Failed to find any matching paired-end reads in ‘./cleaned/Etelis_S36.2.fq.gz’.\nAborted.\n\nJulian Catchen gives the solution here. Because these data were already run through process_radtags once to demultiplex them, it attached a \\1 to the labels of all primary reads and a \\2 to the labels of all paired reads. When I re-ran them in process_radtags, it attached an extra flag to each, which then confused tsv2bam. Julian provides the below code to remove the extra flags.\n\nls  -1 *.1.fq.gz | sed -E 's/\\.1\\.fq\\.gz//' | while read line; do zcat ${line}.1.fq.gz | sed -E 's/\\/1$//' > ../cleaned/${line}.1.fq; done\n\nls  -1 *.2.fq.gz | sed -E 's/\\.2\\.fq\\.gz//' | while read line; do zcat ${line}.2.fq.gz | sed -E 's/\\/2$//' > ../cleaned/${line}.2.fq; done\n\ncd ../cleaned\n\nparallel gzip ::: *"
  },
  {
    "objectID": "Etelis_migrate.html#run-denovo_map.pl",
    "href": "Etelis_migrate.html#run-denovo_map.pl",
    "title": "Gene Flow Models for Etelis spp. Deepwater Snappers",
    "section": "Run denovo_map.pl",
    "text": "Run denovo_map.pl\nI’m going to use the denovo_map.pl pipeline. This command will take data from ./cleaned and the popmap provided by Anne and -m 5 reads per stack, -M 4 distance between stacks, -n 4 distance between catalog loci. Running on 8 -T threads and only keeping loci that appear in 80% of individuals in all 4 populations\n\ndenovo_map.pl --samples ./cleaned/ --popmap popmapECA.tsv --out-path ./pipeline --paired \\\n-m 5 -M 4 -n 4  -T 12 -r 80 -p 4 -X \"populations: --fasta-samples\" -X \"populations: --filter-haplotype-wise\""
  },
  {
    "objectID": "Etelis_migrate.html#populations",
    "href": "Etelis_migrate.html#populations",
    "title": "Gene Flow Models for Etelis spp. Deepwater Snappers",
    "section": "Populations",
    "text": "Populations\nNow I need to re-run populations to get more statistics. Original populations output is in output1, this will be in output2.\n\nr80\nSettings for keeping loci that occur in 80 percent of indivs per population (so 4/5 of the Johnston invivs for coruscans). I’m being intentionally stringent by setting the p-value cutoff for hwe at 0.05.\n\npopulations -P ./ -O ./output2_r80 -M ../popmapECO.tsv -t 12 -p 4 -r 80 -H --hwe --fstats --p-value-cutoff 0.05 --fasta-loci --fasta-samples --vcf --genepop --structure --treemix --fasta-samples-raw \n\n\nE. carbunculus\nRemoved 98351 loci that did not pass sample/population constraints from 115429 loci.\nKept 17078 loci, composed of 5539395 sites; 17697 of those sites were filtered, 49261 variant sites remained.\nNumber of loci with PE contig: 17078.00 (100.0%);\n  Mean length of loci: 314.36bp (stderr 0.38);\nNumber of loci with SE/PE overlap: 2546.00 (14.9%);\n  Mean length of overlapping loci: 285.08bp (stderr 0.47); mean overlap: 27.61bp (stderr 0.13);\nMean genotyped sites per locus: 315.85bp (stderr 0.37).\n\nPopulation summary statistics (more detail in populations.sumstats_summary.tsv):\n  Japan: 13.333 samples per locus; pi: 0.16058; all/variant/polymorphic sites: 5394107/49261/33997; private alleles: 6596\n  MHI: 13.55 samples per locus; pi: 0.15487; all/variant/polymorphic sites: 5394107/49261/31541; private alleles: 3166\n  NWHI: 25.142 samples per locus; pi: 0.15329; all/variant/polymorphic sites: 5394107/49261/38082; private alleles: 7321\n\nNumber of variable sites found to be significantly out of Hardy-Weinberg equilibrium (<0.05):\n  Japan: 1145\n  MHI: 1103\n  NWHI: 1527\nNumber of loci found to be significantly out of Hardy-Weinberg equilibrium (<0.05):\n  Japan: 3917\n  MHI: 4185\n  NWHI: 3407\n(more detail in populations.sumstats.tsv and populations.hapstats.tsv)\n\nPopulation pair divergence statistics (more in populations.fst_summary.tsv and populations.phistats_summary.tsv):\n  Japan-MHI: mean Fst: 0.030208; mean Phi_st: 0.023147; mean Fst': 0.025616; mean Dxy: 0.0019853\n  Japan-NWHI: mean Fst: 0.02638; mean Phi_st: 0.028095; mean Fst': 0.029652; mean Dxy: 0.0019372\n  MHI-NWHI: mean Fst: 0.014407; mean Phi_st: 0.0018347; mean Fst': 0.0016037; mean Dxy: 0.0018308\n\n\nE. coruscans\nRemoved 130579 loci that did not pass sample/population constraints from 141967 loci.\nKept 11388 loci, composed of 3690405 sites; 32281 of those sites were filtered, 59470 variant sites remained.\nNumber of loci with PE contig: 11388.00 (100.0%);\n  Mean length of loci: 314.06bp (stderr 0.42);\nNumber of loci with SE/PE overlap: 1079.00 (9.5%);\n  Mean length of overlapping loci: 291.05bp (stderr 0.59); mean overlap: 24.47bp (stderr 0.12);\nMean genotyped sites per locus: 315.02bp (stderr 0.42).\n\nPopulation summary statistics (more detail in populations.sumstats_summary.tsv):\n  Johnston_Atoll: 4.1993 samples per locus; pi: 0.074411; all/variant/polymorphic sites: 3587423/59470/15449; private alleles: 5208\n  MHI: 13.68 samples per locus; pi: 0.060304; all/variant/polymorphic sites: 3587423/59470/25569; private alleles: 7241\n  NWHI: 26.37 samples per locus; pi: 0.060932; all/variant/polymorphic sites: 3587423/59470/38902; private alleles: 15366\n  Japan: 13.217 samples per locus; pi: 0.054013; all/variant/polymorphic sites: 3587423/59470/22717; private alleles: 6028\n\nNumber of variable sites found to be significantly out of Hardy-Weinberg equilibrium (<0.05):\n  Johnston_Atoll: 7\n  MHI: 1134\n  NWHI: 1648\n  Japan: 700\nNumber of loci found to be significantly out of Hardy-Weinberg equilibrium (<0.05):\n  Johnston_Atoll: 3998\n  MHI: 2984\n  NWHI: 2673\n  Japan: 3395\n(more detail in populations.sumstats.tsv and populations.hapstats.tsv)\n\nPopulation pair divergence statistics (more in populations.fst_summary.tsv and populations.phistats_summary.tsv):\n  Johnston_Atoll-MHI: mean Fst: 0.038243; mean Phi_st: 0.012337; mean Fst': 0.0011598; mean Dxy: 0.0014711\n  Johnston_Atoll-NWHI: mean Fst: 0.022267; mean Phi_st: 0.0056917; mean Fst': -0.0033667; mean Dxy: 0.0013478\n  Johnston_Atoll-Japan: mean Fst: 0.041778; mean Phi_st: 0.018924; mean Fst': 0.0048455; mean Dxy: 0.0014546\n  MHI-NWHI: mean Fst: 0.013568; mean Phi_st: 0.0027592; mean Fst': 0.0011102; mean Dxy: 0.0012735\n  MHI-Japan: mean Fst: 0.021407; mean Phi_st: 0.0058972; mean Fst': 0.0028619; mean Dxy: 0.0013316\n  NWHI-Japan: mean Fst: 0.013484; mean Phi_st: 0.002933; mean Fst': 0.0018245; mean Dxy: 0.0012352\n\n\n\nr100\nSettings for keeping loci that occur in 100 percent of indivs per population ::: {.cell}\npopulations -P ./ -O ./output3_r100 -M ../popmapECO.tsv -t 12 -p 4 -r 100 -H --hwe --fstats --p-value-cutoff 0.05 --fasta-loci --fasta-samples --vcf --genepop --structure --treemix --fasta-samples-raw \n:::\n\nE. carbunculus\nRemoved 111882 loci that did not pass sample/population constraints from 115429 loci.\nKept 3547 loci, composed of 1134453 sites; 6916 of those sites were filtered, 6537 variant sites remained.\nNumber of loci with PE contig: 3547.00 (100.0%);\n  Mean length of loci: 309.83bp (stderr 0.69);\nNumber of loci with SE/PE overlap: 288.00 (8.1%);\n  Mean length of overlapping loci: 285.06bp (stderr 1.00); mean overlap: 24.45bp (stderr 0.24);\nMean genotyped sites per locus: 310.68bp (stderr 0.68).\n\nPopulation summary statistics (more detail in populations.sumstats_summary.tsv):\n  Japan: 14 samples per locus; pi: 0.10528; all/variant/polymorphic sites: 1101972/6537/3955; private alleles: 1170\n  MHI: 14 samples per locus; pi: 0.09766; all/variant/polymorphic sites: 1101972/6537/3434; private alleles: 511\n  NWHI: 27 samples per locus; pi: 0.097747; all/variant/polymorphic sites: 1101972/6537/4642; private alleles: 1340\n\nNumber of variable sites found to be significantly out of Hardy-Weinberg equilibrium (<0.05):\n  Japan: 101\n  MHI: 90\n  NWHI: 110\nNumber of loci found to be significantly out of Hardy-Weinberg equilibrium (<0.05):\n  Japan: 1197\n  MHI: 1358\n  NWHI: 1331\n(more detail in populations.sumstats.tsv and populations.hapstats.tsv)\n\nPopulation pair divergence statistics (more in populations.fst_summary.tsv and populations.phistats_summary.tsv):\n  Japan-MHI: mean Fst: 0.025802; mean Phi_st: 0.015567; mean Fst': 0.0094451; mean Dxy: 0.00087231\n  Japan-NWHI: mean Fst: 0.020607; mean Phi_st: 0.018272; mean Fst': 0.010517; mean Dxy: 0.00082861\n  MHI-NWHI: mean Fst: 0.012892; mean Phi_st: 0.00097809; mean Fst': 0.00022075; mean Dxy: 0.00081207\n\n\nE. coruscans\nRemoved 140925 loci that did not pass sample/population constraints from 141967 loci.\nKept 1042 loci, composed of 334846 sites; 3569 of those sites were filtered, 3654 variant sites remained.\nNumber of loci with PE contig: 1042.00 (100.0%);\n  Mean length of loci: 311.35bp (stderr 1.36);\nNumber of loci with SE/PE overlap: 117.00 (11.2%);\n  Mean length of overlapping loci: 285.68bp (stderr 1.71); mean overlap: 24.41bp (stderr 0.38);\nMean genotyped sites per locus: 312.62bp (stderr 1.33).\n\nPopulation summary statistics (more detail in populations.sumstats_summary.tsv):\n  Johnston_Atoll: 5 samples per locus; pi: 0.060494; all/variant/polymorphic sites: 325749/3654/975; private alleles: 520\n  MHI: 14 samples per locus; pi: 0.036669; all/variant/polymorphic sites: 325749/3654/1226; private alleles: 470\n  NWHI: 27 samples per locus; pi: 0.037317; all/variant/polymorphic sites: 325749/3654/2064; private alleles: 1019\n  Japan: 14 samples per locus; pi: 0.033766; all/variant/polymorphic sites: 325749/3654/1143; private alleles: 463\n\nNumber of variable sites found to be significantly out of Hardy-Weinberg equilibrium (<0.05):\n  Johnston_Atoll: 0\n  MHI: 32\n  NWHI: 45\n  Japan: 19\nNumber of loci found to be significantly out of Hardy-Weinberg equilibrium (<0.05):\n  Johnston_Atoll: 524\n  MHI: 422\n  NWHI: 405\n  Japan: 396\n(more detail in populations.sumstats.tsv and populations.hapstats.tsv)\n\nPopulation pair divergence statistics (more in populations.fst_summary.tsv and populations.phistats_summary.tsv):\n  Johnston_Atoll-MHI: mean Fst: 0.039663; mean Phi_st: 0.02039; mean Fst': 0.0012821; mean Dxy: 0.00073676\n  Johnston_Atoll-NWHI: mean Fst: 0.026268; mean Phi_st: 0.015567; mean Fst': 0.00037957; mean Dxy: 0.0006556\n  Johnston_Atoll-Japan: mean Fst: 0.041015; mean Phi_st: 0.020409; mean Fst': 0.0021605; mean Dxy: 0.0007176\n  MHI-NWHI: mean Fst: 0.012433; mean Phi_st: 0.00025697; mean Fst': 4.0397e-05; mean Dxy: 0.00049144\n  MHI-Japan: mean Fst: 0.019806; mean Phi_st: 0.0039369; mean Fst': 0.00060169; mean Dxy: 0.00050736\n  NWHI-Japan: mean Fst: 0.012751; mean Phi_st: 0.0020762; mean Fst': 0.00052502; mean Dxy: 0.00047009"
  },
  {
    "objectID": "Etelis_migrate.html#download-the-populations-output",
    "href": "Etelis_migrate.html#download-the-populations-output",
    "title": "Gene Flow Models for Etelis spp. Deepwater Snappers",
    "section": "Download the populations output",
    "text": "Download the populations output\n\nscp -r argo:./Etelis/coruscans/pipeline/output3_r100 ./populations_r100\nscp -r argo:./Etelis/carbunculus/pipeline/output3_r100 ./populations_r100"
  },
  {
    "objectID": "Etelis_migrate.html#snpr",
    "href": "Etelis_migrate.html#snpr",
    "title": "Gene Flow Models for Etelis spp. Deepwater Snappers",
    "section": "SNPr",
    "text": "SNPr\n\npopmap <- read_tsv(\"coruscans/popmapECO.tsv\",col_names = c(\"sampID\",\"pop\"))\necor_haps <- read_vcf(file = \"coruscans/populations_r100/populations.haps.vcf\",sample.meta = popmap)\n\necor_haps <- calc_ho(ecor_haps, facets = \"pop\")\necor_haps <- calc_he(ecor_haps, facets = \"pop\")\necor_haps <- calc_maf(ecor_haps, facets = \"pop\")\necor_haps <- calc_pi(ecor_haps, facets = \"pop\")\necor_haps <- calc_private(ecor_haps, facets = \"pop\")\necor_haps <- calc_hwe(ecor_haps, facets = \"pop\")\necor_haps <- calc_fis(ecor_haps, facets = \"pop\")\n\nstats <- get.snpR.stats(ecor_haps, \"pop\", stats = c(\"maf\", \"ho\",\"he\",\"hwe\", \"fis\",\"pi\", \"private\")) \n\n\n# and dang, just like that we can get a PCA\np <- plot_clusters(ecor_haps, facets = \"pop\")\np$plots$pca\n\nHmmm… I’m thinking that it is assuming that the data are biallelic."
  },
  {
    "objectID": "Etelis_migrate.html#adegenet",
    "href": "Etelis_migrate.html#adegenet",
    "title": "Gene Flow Models for Etelis spp. Deepwater Snappers",
    "section": "Adegenet",
    "text": "Adegenet\n\necor_haps <- read.genepop(\"coruscans/populations_r100/populations.haps.gen\")\n\n\n Converting data from a Genepop .gen file to a genind object... \n\n\nFile description:  Stacks v2.61; GenePop v4.1.3; September 30, 2022 \n\n...done.\n\nlevels(ecor_haps$pop) <- c(\"JA\",\"MHI\",\"NWHI\",\"OK\")\n\necor_dapc <- dapc(ecor_haps,pop =  ecor_haps$pop, scale = T, pca.select=\"nbEig\", n.pca = 50, n.da=3)\n\nWarning in .local(x, ...): Some scaling values are null.\n Corresponding alleles are removed.\n\nscatter(ecor_dapc)"
  }
]